<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório Azure DevOps</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <!-- Overlay de Loading -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
            <p class="text-gray-700 text-lg font-medium" id="loadingText">Gerando relatório...</p>
            <p class="text-gray-500 text-sm mt-2" id="loadingProgress"></p>
        </div>
    </div>

    <!-- Toast de Notificação -->
    <div id="toast" class="fixed top-4 right-4 z-50 hidden transform transition-all duration-300">
        <div class="bg-white rounded-lg shadow-lg p-4 max-w-md">
            <div class="flex items-center">
                <div id="toastIcon" class="flex-shrink-0 w-6 h-6 mr-3"></div>
                <div>
                    <p id="toastMessage" class="text-sm font-medium text-gray-900"></p>
                    <p id="toastDetail" class="text-sm text-gray-500 mt-1"></p>
                </div>
            </div>
        </div>
    </div>

    <div class="min-h-screen py-12">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Card Principal -->
            <div class="bg-white rounded-xl shadow-xl overflow-hidden">
                <!-- Cabeçalho -->
                <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4">
                    <h1 class="text-2xl font-bold text-white flex items-center">
                        <i class="fas fa-file-excel mr-3"></i>
                        Relatório Azure DevOps
                    </h1>
                </div>

                <!-- Formulário -->
                <div class="p-6 space-y-6">
                    <!-- PAT Input com ícone e tooltip -->
                    <div class="relative">
                        <label for="pat" class="block text-sm font-medium text-gray-700 flex items-center">
                            Personal Access Token (PAT)
                            <i class="fas fa-info-circle ml-2 text-gray-400 hover:text-blue-500 cursor-pointer"
                               title="Token de acesso pessoal do Azure DevOps"></i>
                        </label>
                        <div class="mt-1 relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-key text-gray-400"></i>
                            </div>
                            <input type="password" 
                                   id="pat" 
                                   placeholder="Cole seu PAT aqui" 
                                   class="pl-10 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <!-- Filtros em Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Código do Card -->
                        <div>
                            <label for="cardId" class="block text-sm font-medium text-gray-700">
                                Código do Card (opcional)
                            </label>
                            <div class="mt-1 relative rounded-md shadow-sm">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-hashtag text-gray-400"></i>
                                </div>
                                <input type="number" 
                                       id="cardId" 
                                       placeholder="Ex: 123" 
                                       class="pl-10 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>

                        <!-- Período -->
                        <div>
                            <label for="dateRange" class="block text-sm font-medium text-gray-700">
                                Período (opcional)
                            </label>
                            <div class="mt-1 relative rounded-md shadow-sm">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-calendar text-gray-400"></i>
                                </div>
                                <input type="text" 
                                       id="dateRange" 
                                       placeholder="Selecione o período" 
                                       class="pl-10 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                    </div>

                    <!-- Botão Gerar com efeito hover -->
                    <div class="flex justify-end space-x-4">
                        <button onclick="analisarCard()" 
                                id="btnAnalisar"
                                disabled
                                class="group relative inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                            <span class="flex items-center">
                                <i class="fas fa-search mr-2"></i>
                                Analisar Card
                            </span>
                        </button>
                        <button onclick="gerarRelatorio()" 
                                id="btnGerar"
                                class="group relative inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200">
                            <span class="flex items-center">
                                <i class="fas fa-file-excel mr-2"></i>
                                Gerar Relatório
                            </span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sidebar do Histórico -->
            <div class="space-y-6 mt-6">
                <!-- Gráfico -->
                <div id="chartContainer" class="hidden">
                    <div class="bg-white rounded-xl shadow-xl overflow-hidden">
                        <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4">
                            <h2 class="text-xl font-bold text-white flex items-center">
                                <i class="fas fa-chart-bar mr-3"></i>
                                Análise de Tempo
                            </h2>
                        </div>
                        <div class="p-4 space-y-6">
                            <!-- Gráfico de Barras -->
                            <div>
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Tempo em cada Status</h3>
                                <div class="h-[300px]">
                                    <canvas id="statusChart"></canvas>
                                </div>
                            </div>
                            
                            <!-- Gráfico de Pizza -->
                            <div class="mt-8">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Distribuição do Tempo (%)</h3>
                                <div class="h-[300px]">
                                    <canvas id="pieChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Histórico -->
                <div id="historySidebar" class="hidden">
                    <div class="bg-white rounded-xl shadow-xl overflow-hidden">
                        <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4">
                            <h2 class="text-xl font-bold text-white flex items-center">
                                <i class="fas fa-history mr-3"></i>
                                Histórico do Card
                            </h2>
                        </div>
                        <div id="historyContent" class="p-4 max-h-[600px] overflow-y-auto">
                            <!-- O histórico será inserido aqui -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Inicializar o seletor de data
        flatpickr("#dateRange", {
            mode: "range",
            dateFormat: "d/m/Y",
            locale: "pt",
            theme: "material_blue",
            placeholder: "Selecione o período",
            allowInput: true,
            time_24hr: true,
            enableTime: false,
            defaultHour: 0
        });

        function showToast(type, message, detail = '') {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toastIcon');
            const toastMessage = document.getElementById('toastMessage');
            const toastDetail = document.getElementById('toastDetail');

            if (type === 'success') {
                toastIcon.innerHTML = '<i class="fas fa-check-circle text-green-500 text-xl"></i>';
            } else {
                toastIcon.innerHTML = '<i class="fas fa-exclamation-circle text-red-500 text-xl"></i>';
            }

            toastMessage.textContent = message;
            toastDetail.textContent = detail;

            toast.classList.remove('hidden');
            toast.classList.add('transform', 'translate-y-0', 'opacity-100');

            setTimeout(() => {
                toast.classList.add('hidden');
            }, 5000);
        }

        async function gerarRelatorio() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            const loadingProgress = document.getElementById('loadingProgress');
            const btnGerar = document.getElementById('btnGerar');
            const pat = document.getElementById('pat').value;
            
            if (!pat) {
                showToast('error', 'Token PAT é obrigatório', 'Por favor, insira um token válido para continuar.');
                return;
            }

            try {
                loadingOverlay.classList.remove('hidden');
                btnGerar.disabled = true;
                loadingText.textContent = 'Iniciando geração do relatório...';

                const response = await fetch('report.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pat: pat,
                        cardId: document.getElementById('cardId').value,
                        dateRange: document.getElementById('dateRange').value
                    })
                });

                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error);
                }

                if (data.totalItems && data.processedItems) {
                    const progress = Math.round((data.processedItems / data.totalItems) * 100);
                    loadingProgress.textContent = `Processado ${progress}% (${data.processedItems}/${data.totalItems})`;
                }

                showToast('success', 'Relatório gerado com sucesso!', 'Iniciando download...');
                window.location.href = data.filename;

            } catch (error) {
                showToast('error', 'Erro ao gerar relatório', error.message);
                console.error('Detalhes do erro:', error);
            } finally {
                loadingOverlay.classList.add('hidden');
                btnGerar.disabled = false;
            }
        }

        // Habilitar/desabilitar botão Analisar baseado no input do card
        document.getElementById('cardId').addEventListener('input', function(e) {
            const btnAnalisar = document.getElementById('btnAnalisar');
            btnAnalisar.disabled = !this.value;
        });

        let statusChart = null;
        let pieChart = null;

        async function analisarCard() {
            const cardId = document.getElementById('cardId').value;
            const pat = document.getElementById('pat').value;
            const historySidebar = document.getElementById('historySidebar');
            const historyContent = document.getElementById('historyContent');
            const btnAnalisar = document.getElementById('btnAnalisar');
            
            if (!cardId) {
                showToast('error', 'Código do card é obrigatório', 'Por favor, insira um código de card válido.');
                return;
            }
            
            if (!pat) {
                showToast('error', 'Token PAT é obrigatório', 'Por favor, insira um token válido para continuar.');
                return;
            }

            try {
                btnAnalisar.disabled = true;
                historyContent.innerHTML = '<div class="flex justify-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div></div>';
                historySidebar.classList.remove('hidden');
                
                const chartContainer = document.getElementById('chartContainer');
                chartContainer.classList.remove('hidden');

                const response = await fetch('analyze_card.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pat: pat,
                        cardId: cardId
                    })
                });

                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error);
                }

                // Renderizar histórico
                let html = '<div class="space-y-4">';
                data.history.forEach(item => {
                    html += `
                        <div class="border-l-4 border-blue-500 pl-4 py-2">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-500">${item.date}</span>
                                <span class="text-sm font-medium text-gray-700">${item.author}</span>
                            </div>
                            <div class="mt-2 flex items-center">
                                <span class="text-red-500 line-through">${item.oldState}</span>
                                <i class="fas fa-arrow-right mx-2 text-gray-400"></i>
                                <span class="text-green-500">${item.newState}</span>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                historyContent.innerHTML = html;

                // Renderizar gráfico
                const ctx = document.getElementById('statusChart').getContext('2d');
                
                // Destruir gráfico existente se houver
                if (statusChart) {
                    statusChart.destroy();
                }

                // Definir paleta de cores expandida
                const statusColors = {
                    'New': '#4F46E5', // Indigo
                    'Em desenvolvimento': '#7C3AED', // Violet
                    'Aprovado Desenvolvimento': '#EC4899', // Pink
                    'Liberado para Teste TI': '#EF4444', // Red
                    'Liberado para Teste Usuário': '#F59E0B', // Amber
                    'Aprovado (Teste)': '#10B981', // Emerald
                    'Liberado para Replicar': '#06B6D4', // Cyan
                    'Done': '#2563EB', // Blue
                    'Blocked': '#DC2626', // Red
                    'Removed': '#6B7280', // Gray
                    'In Progress': '#8B5CF6', // Purple
                    'To Do': '#3B82F6', // Blue
                    'Code Review': '#14B8A6', // Teal
                    'Ready for Test': '#F97316' // Orange
                };

                // Atualizar configuração do gráfico de barras
                statusChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.durations.map(item => `${item.status} (${item.formatted})`),
                        datasets: [{
                            label: 'Tempo em Status',
                            data: data.durations.map(item => Math.abs(item.duration)),
                            backgroundColor: data.durations.map(item => statusColors[item.status] || '#9CA3AF')
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Duração em cada Status',
                                font: {
                                    size: 16
                                }
                            },
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const item = data.durations[context.dataIndex];
                                        return `${item.formatted}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Tempo (horas)'
                                },
                                grid: {
                                    display: true
                                },
                                min: 0,
                                suggestedMax: Math.max(...data.durations.map(item => Math.abs(item.duration))) * 1.1,
                                ticks: {
                                    callback: function(value) {
                                        return Math.abs(value);
                                    },
                                    maxTicksLimit: 8
                                }
                            },
                            y: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        },
                        layout: {
                            padding: {
                                right: 20
                            }
                        }
                    }
                });

                // Após o gráfico de barras, adicionar o gráfico de pizza
                const pieCtx = document.getElementById('pieChart').getContext('2d');
                
                // Destruir gráfico de pizza existente se houver
                if (pieChart) {
                    pieChart.destroy();
                }

                // Calcular o total de horas
                const totalHours = data.durations.reduce((sum, item) => sum + Math.abs(item.duration), 0);

                // Atualizar também o gráfico de pizza para usar a mesma paleta de cores
                const pieData = {
                    labels: data.durations.map(item => {
                        const percentage = ((Math.abs(item.duration) / totalHours) * 100).toFixed(1);
                        return `${item.status} (${percentage}% - ${item.formatted})`;
                    }),
                    datasets: [{
                        data: data.durations.map(item => {
                            const percentage = (Math.abs(item.duration) / totalHours) * 100;
                            return percentage.toFixed(1);
                        }),
                        backgroundColor: data.durations.map(item => statusColors[item.status] || '#9CA3AF')
                    }]
                };

                // Criar gráfico de pizza
                pieChart = new Chart(pieCtx, {
                    type: 'doughnut',
                    data: pieData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    generateLabels: function(chart) {
                                        const data = chart.data;
                                        if (data.labels.length && data.datasets.length) {
                                            return data.labels.map((label, i) => {
                                                const value = data.datasets[0].data[i];
                                                const hours = Math.abs(totalHours * value / 100);
                                                const days = Math.floor(hours / 24);
                                                const remainingHours = Math.round(hours % 24);
                                                
                                                return {
                                                    text: `${label} (${value}% - ${days}d ${remainingHours}h)`,
                                                    fillStyle: data.datasets[0].backgroundColor[i],
                                                    hidden: false,
                                                    index: i
                                                };
                                            });
                                        }
                                        return [];
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw;
                                        const hours = Math.abs(totalHours * value / 100);
                                        const days = Math.floor(hours / 24);
                                        const remainingHours = Math.round(hours % 24);
                                        return `${context.label}: ${value}% (${days}d ${remainingHours}h)`;
                                    }
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                showToast('error', 'Erro ao analisar card', error.message);
                console.error('Detalhes do erro:', error);
                historySidebar.classList.add('hidden');
                chartContainer.classList.add('hidden');
            } finally {
                btnAnalisar.disabled = false;
            }
        }
    </script>
</body>
</html> 